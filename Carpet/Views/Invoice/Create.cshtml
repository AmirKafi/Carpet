@model Carpet.Models.DTOs.CreateInvoiceDto
@{
    ViewData["Title"] = "Ø«Ø¨Øª ÙØ§Ú©ØªÙˆØ± ÙØ±Ø´";
}

<div class="container py-4">
    <div class="card p-4">
        <h4 class="mb-4 text-center">ğŸ§¾ Ø«Ø¨Øª ÙØ§Ú©ØªÙˆØ± ÙØ±ÙˆØ´ ÙØ±Ø´</h4>

        <form id="invoiceForm">
            <div class="row mb-3">
                <div class="col-md-4">
                    <label>Ù†Ø§Ù… Ù…Ø´ØªØ±ÛŒ</label>
                    <input type="text" class="form-control" id="CustomerName" name="CustomerName" required>
                </div>
                <div class="col-md-4">
                    <label>ØªØ§Ø±ÛŒØ® ÙØ§Ú©ØªÙˆØ±</label>
                    <input type="date" class="form-control" id="InvoiceDate" name="InvoiceDate" required>
                </div>
                <div class="col-md-4">
                    <label>Ø´Ù…Ø§Ø±Ù‡ ÙØ§Ú©ØªÙˆØ±</label>
                    <input type="text" class="form-control" id="InvoiceNo" name="InvoiceNo" placeholder="Ù…Ø«Ù„Ø§Ù‹ 1400-01" required>
                </div>
            </div>

            <hr>

            <div class="row mb-3">
                <div class="col-md-6 position-relative">
                    <label>Ù†Ø§Ù… ÙØ±Ø´</label>
                    <input type="text" id="CarpetSearch" class="form-control" placeholder="Ø¬Ø³ØªØ¬ÙˆÛŒ Ù†Ø§Ù… ÙØ±Ø´...">
                    <div id="SearchResults" class="bg-white position-absolute w-100" style="z-index: 1000; max-height: 200px; overflow-y: auto; border: 1px solid #ddd; border-radius: 4px; display: none;"></div>
                </div>
                <div class="col-md-2">
                    <label>ØªØ¹Ø¯Ø§Ø¯</label>
                    <input type="number" id="Qty" class="form-control" min="1" value="1">
                </div>
                <div class="col-md-2">
                    <label>Ù‚ÛŒÙ…Øª ÙˆØ§Ø­Ø¯ (ØªÙˆÙ…Ø§Ù†)</label>
                    <input type="number" id="Price" class="form-control" min="0" value="0">
                </div>
                <div class="col-md-2 d-flex align-items-end">
                    <button type="button" id="AddItem" class="btn btn-success w-100">â• Ø§ÙØ²ÙˆØ¯Ù†</button>
                </div>
            </div>

            <table class="table table-bordered text-center align-middle">
                <thead class="table-light">
                    <tr>
                        <th>Ø±Ø¯ÛŒÙ</th>
                        <th>Ù†Ø§Ù… ÙØ±Ø´</th>
                        <th>ØªØ¹Ø¯Ø§Ø¯</th>
                        <th>Ù‚ÛŒÙ…Øª ÙˆØ§Ø­Ø¯</th>
                        <th>Ù…Ø¨Ù„Øº Ú©Ù„</th>
                        <th>Ø­Ø°Ù</th>
                    </tr>
                </thead>
                <tbody id="InvoiceItems"></tbody>
            </table>

            <div class="text-end mt-3">
                <p>Ø¬Ù…Ø¹ Ú©Ù„: <span id="TotalAmount">0</span> ØªÙˆÙ…Ø§Ù†</p>
                <p>Ù…Ø§Ù„ÛŒØ§Øª (9Ùª): <span id="Tax">0</span> ØªÙˆÙ…Ø§Ù†</p>
                <h5>Ù…Ø¨Ù„Øº Ù†Ù‡Ø§ÛŒÛŒ: <span id="FinalTotal">0</span> ØªÙˆÙ…Ø§Ù†</h5>
            </div>

            <div class="text-center mt-4">
                <button type="submit" class="btn btn-primary btn-lg">ğŸ’¾ Ø«Ø¨Øª ÙØ§Ú©ØªÙˆØ±</button>
            </div>
        </form>
    </div>
</div>

@section Scripts {
    <script>
        let items = [];

        // Set today's date as default
        document.getElementById('InvoiceDate').valueAsDate = new Date();

        // Search carpets from API
        $("#CarpetSearch").on("input", function() {
            let q = $(this).val().toLowerCase();
            if (q.length === 0) {
                $("#SearchResults").hide().empty();
                return;
            }

            $.ajax({
                url: '/api/Carpet/search?term=' + encodeURIComponent(q),
                method: 'GET',
                success: function(carpets) {
                    $("#SearchResults").empty();
                    if (carpets && carpets.length > 0) {
                        carpets.forEach(function(carpet) {
                            $("#SearchResults").append(
                                '<div class="search-result p-2" style="cursor: pointer;" data-name="' + 
                                carpet.name + '" data-price="' + carpet.price + '">' + 
                                carpet.name + ' - ' + carpet.price.toLocaleString() + ' ØªÙˆÙ…Ø§Ù†</div>'
                            );
                        });
                        $("#SearchResults").show();
                    } else {
                        $("#SearchResults").hide();
                    }
                },
                error: function() {
                    $("#SearchResults").hide().empty();
                }
            });
        });

        // Select from search
        $(document).on("click", ".search-result", function() {
            $("#CarpetSearch").val($(this).data("name"));
            $("#Price").val($(this).data("price"));
            $("#SearchResults").hide().empty();
        });

        // Hide search results when clicking outside
        $(document).on("click", function(e) {
            if (!$(e.target).closest("#CarpetSearch, #SearchResults").length) {
                $("#SearchResults").hide();
            }
        });

        // Add item
        $("#AddItem").click(function() {
            let name = $("#CarpetSearch").val().trim();
            let qty = parseInt($("#Qty").val());
            let price = parseFloat($("#Price").val());

            if (!name || qty <= 0 || price <= 0) {
                alert("Ù„Ø·ÙØ§Ù‹ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø±Ø§ Ú©Ø§Ù…Ù„ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯");
                return;
            }

            items.push({ name: name, qty: qty, price: price });
            updateTable();
            $("#CarpetSearch").val("");
            $("#Qty").val(1);
            $("#Price").val(0);
            $("#SearchResults").hide().empty();
        });

        // Delete item
        $(document).on("click", ".delete-item", function() {
            let index = $(this).data("index");
            items.splice(index, 1);
            updateTable();
        });

        function updateTable() {
            let total = 0;
            $("#InvoiceItems").empty();
            items.forEach(function(it, i) {
                let sum = it.qty * it.price;
                total += sum;
                $("#InvoiceItems").append(
                    '<tr>' +
                    '<td>' + (i + 1) + '</td>' +
                    '<td>' + it.name + '</td>' +
                    '<td>' + it.qty + '</td>' +
                    '<td>' + it.price.toLocaleString() + '</td>' +
                    '<td>' + sum.toLocaleString() + '</td>' +
                    '<td><button class="btn btn-sm btn-danger delete-item" data-index="' + i + '">ğŸ—‘</button></td>' +
                    '</tr>'
                );
            });
            let tax = total * 0.09;
            $("#TotalAmount").text(total.toLocaleString());
            $("#Tax").text(tax.toLocaleString());
            $("#FinalTotal").text((total + tax).toLocaleString());
        }

        // Submit form
        $("#invoiceForm").submit(function(e) {
            e.preventDefault();
            if (items.length === 0) {
                alert("Ù‡ÛŒÚ† Ø¢ÛŒØªÙ…ÛŒ Ø¯Ø± ÙØ§Ú©ØªÙˆØ± Ù†ÛŒØ³Øª!");
                return;
            }

            let data = {
                CustomerName: $("#CustomerName").val(),
                InvoiceDate: $("#InvoiceDate").val(),
                InvoiceNo: $("#InvoiceNo").val(),
                Items: items.map(function(item) {
                    return {
                        CarpetName: item.name,
                        Quantity: item.qty,
                        UnitPrice: item.price
                    };
                })
            };

            $.ajax({
                url: '/api/InvoiceApi',
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(data),
                success: function(response) {
                    alert("âœ… ÙØ§Ú©ØªÙˆØ± Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø«Ø¨Øª Ø´Ø¯!");
                    window.location.href = '/Invoice';
                },
                error: function(xhr) {
                    let errorMessage = "Ø®Ø·Ø§ Ø¯Ø± Ø«Ø¨Øª ÙØ§Ú©ØªÙˆØ±";
                    if (xhr.responseJSON && xhr.responseJSON.message) {
                        errorMessage = xhr.responseJSON.message;
                    }
                    alert(errorMessage);
                }
            });
        });
    </script>
}

<style>
    body {
        background: #f8f9fa;
        direction: rtl;
    }
    .card {
        box-shadow: 0 3px 10px rgba(0,0,0,0.1);
        border-radius: 15px;
    }
    .search-result {
        cursor: pointer;
        padding: 5px;
        border-bottom: 1px solid #ddd;
    }
    .search-result:hover {
        background-color: #f0f0f0;
    }
</style>

